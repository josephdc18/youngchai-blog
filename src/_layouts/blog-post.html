---
layout: 'base.html'
preloadCSS: '/css/blog.css'
eleventyComputed:
    description: "{{ description | default: blogDescription }}"
    metaTitle: "{{ title | default: blogTitle }}"
    tagTitle: "{{ title | default: blogTitle }}"
    preloadImg: "{{ image }}"
    permalink: "{% if locale == 'ko' %}/ko{% endif %}/blog/{{ slug | default: pageName }}/index.html"
---
{% set currentLocale = locale | default(page.url | getLocale) %}
{% set postTitle = title | default(blogTitle) %}
{% set postDescription = description | default(blogDescription) %}
{% set featuredCollection = 'featured_' + currentLocale %}
{% set postSlug = slug | default(pageName) %}

<!-- ============================================ -->
<!--                    LANDING                   -->
<!-- ============================================ -->

<section id="int-hero" style="background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('{{ image }}') center/cover no-repeat;">
</section>

<!-- ============================================ -->
<!--              Main Blog Content               -->
<!-- ============================================ -->

<div class="blog-container main-content-wrapper">
    <!--Main content -->
    <div class="main-content">
        <!-- ============================================ -->
        <!--                  Blog Article                -->
        <!-- ============================================ -->

        <article class="blog-article">
            <!--Main Article Image-->
            <picture class="blog-mainImage">
                <img src="{{ image }}" alt="{{ imageAlt }}" width="795" height="400" decoding="async"/>
            </picture>

            <!--Article Info-->
            <div class="article-group">
                <h1 class="blog-h1">{{ postTitle }}</h1>
                <div class="blog-authorGroup">
                    <!--Author Image-->
                    <picture class="blog-author-img">
                        <img
                            src="/assets/svgs/profile.svg"
                            alt="{{ author }}"
                            width="32"
                            height="32"
                            decoding="async"
                        />
                    </picture>
                    <span class="blog-author">{{ author }}</span>
                    <span aria-hidden="true" class="blog-dot"></span>
                    <!--Blog Date-->
                    <span class="blog-date">{{ date | postDateLocale(currentLocale) }}</span>
                </div>
            </div>
            <section id="blog-content">
                {{ content | safe }}
            </section>
        </article>

        <!-- ============================================ -->
        <!--              Comments Section                -->
        <!-- ============================================ -->
        <section class="comments-section" id="comments-section">
            <div class="comments-header">
                <h2 class="comments-title">
                    <i data-lucide="message-circle" width="24" height="24"></i>
                    <span>{{ 'Comments' if currentLocale == 'en' else '댓글' }}</span>
                    <span class="comment-count" id="comment-count">0</span>
                </h2>
            </div>

            <!-- New Comment Form -->
            <div class="new-comment-form-container" id="new-comment-form-container">
                <form class="inline-comment-form" id="new-comment-form">
                    <div class="comment-form-header">
                        <i data-lucide="edit-3" width="18" height="18"></i>
                        <span>{{ 'Write a comment' if currentLocale == 'en' else '댓글 작성' }}</span>
                    </div>
                    <div class="comment-form-row">
                        <div class="floating-label-group">
                            <input type="text" name="commenter-name" id="new-commenter-name" placeholder=" " required>
                            <label for="new-commenter-name">{{ 'Your Name' if currentLocale == 'en' else '이름' }}</label>
                        </div>
                        <div class="floating-label-group">
                            <input type="email" name="commenter-email" id="new-commenter-email" placeholder=" ">
                            <label for="new-commenter-email">{{ 'Email (optional)' if currentLocale == 'en' else '이메일 (선택)' }}</label>
                        </div>
                    </div>
                    <div class="floating-label-group">
                        <textarea name="comment-text" id="new-comment-text" rows="3" placeholder=" " required></textarea>
                        <label for="new-comment-text">{{ 'Share your thoughts...' if currentLocale == 'en' else '생각을 공유하세요...' }}</label>
                    </div>
                    <button type="submit" class="comment-submit-btn" id="submit-comment-btn">
                        <span>{{ 'Post Comment' if currentLocale == 'en' else '댓글 달기' }}</span>
                        <i data-lucide="send" width="16" height="16"></i>
                    </button>
                </form>
            </div>

            <!-- Comments List -->
            <div class="comments-list" id="comments-list">
                <!-- Comments will be loaded from API -->
                <div class="comments-loading" id="comments-loading">
                    <span>{{ 'Loading comments...' if currentLocale == 'en' else '댓글 로딩 중...' }}</span>
                </div>
            </div>
        </section>
    </div>
    <!-- End .main-content -->

    <!-- ============================================ -->
    <!--                   Sidebar                    -->
    <!-- ============================================ -->

    <div class="blog-sidebar">
        <div class="sticky-wrapper">
            <div class="widget-box">
                <div class="corner-tr"></div>
                <div class="corner-bl"></div>

                <div class="widget-header">
                    <i data-lucide="star" class="text-accent" width="20" height="20"></i>
                    <h3 class="italic" style="font-size: 1.25rem;">{{ 'blog.featuredPosts' | t(currentLocale) }}</h3>
                </div>

                <ul class="widget-list">
                    {% set featuredPosts = collections[featuredCollection] | default(collections.featured) | default([]) %}
                    {% if featuredPosts | length > 0 %}
                        {%- for post in featuredPosts | head(5) -%}
                            {%- set index = loop.index -%}
                            <li class="group">
                                <div class="widget-list-meta">
                                    <span class="widget-num">{{ index | padStart(2, '0') }}</span>
                                    <span class="widget-tag">{{ post.data.category | upper | default('BLOG') }}</span>
                                </div>
                                <a href="{{ post.url }}">
                                    <h4 class="widget-title">{{ post.data.title | default(post.data.blogTitle) }}</h4>
                                </a>
                            </li>
                        {%- endfor -%}
                    {% else %}
                        <li>
                            <p class="post-excerpt" style="font-size: 0.9rem;">
                                {{ 'Featured posts will appear here.' if currentLocale == 'en' else '추천 글이 여기에 표시됩니다.' }}
                            </p>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Sticky Comment Bar -->
<div class="sticky-comment-bar" id="sticky-comment-bar">
    <div class="sticky-comment-inner">
        <div class="sticky-comment-info">
            <i data-lucide="message-circle" width="18" height="18"></i>
            <span><strong id="sticky-count">0</strong> {{ 'Comments' if currentLocale == 'en' else '댓글' }}</span>
        </div>
        <button class="write-comment-btn" id="write-comment-btn">
            <i data-lucide="edit-3" width="16" height="16"></i>
            <span>{{ 'Write a Comment' if currentLocale == 'en' else '댓글 작성' }}</span>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentLocale = '{{ currentLocale }}';
    const postSlug = '{{ postSlug }}';
    const API_BASE = '/api/comments';
    
    const stickyBar = document.getElementById('sticky-comment-bar');
    const writeCommentBtn = document.getElementById('write-comment-btn');
    const newCommentForm = document.getElementById('new-comment-form');
    const commentsList = document.getElementById('comments-list');
    const commentsLoading = document.getElementById('comments-loading');
    const commentCount = document.getElementById('comment-count');
    const stickyCount = document.getElementById('sticky-count');
    const submitBtn = document.getElementById('submit-comment-btn');

    // Localized strings
    const strings = {
        en: {
            justNow: 'Just now',
            reply: 'Reply',
            cancel: 'Cancel',
            yourName: 'Your Name',
            replyPlaceholder: 'Write your reply...',
            noComments: 'Be the first to comment!',
            posting: 'Posting...',
            postComment: 'Post Comment',
            error: 'Error posting comment. Please try again.'
        },
        ko: {
            justNow: '방금 전',
            reply: '답글',
            cancel: '취소',
            yourName: '이름',
            replyPlaceholder: '답글을 작성하세요...',
            noComments: '첫 번째 댓글을 남겨보세요!',
            posting: '게시 중...',
            postComment: '댓글 달기',
            error: '댓글 게시 중 오류가 발생했습니다. 다시 시도해주세요.'
        }
    };
    const t = strings[currentLocale] || strings.en;

    // Load comments from API
    async function loadComments() {
        try {
            const response = await fetch(`${API_BASE}?post=${encodeURIComponent(postSlug)}`);
            if (!response.ok) throw new Error('Failed to load comments');
            
            const data = await response.json();
            renderComments(data.comments || []);
        } catch (error) {
            console.error('Error loading comments:', error);
            commentsLoading.innerHTML = `<p style="color: var(--color-gray-medium);">${t.noComments}</p>`;
        }
    }

    // Render comments
    function renderComments(comments) {
        commentsLoading.style.display = 'none';
        
        if (comments.length === 0) {
            commentsList.innerHTML = `<p class="no-comments" style="color: var(--color-gray-medium); text-align: center; padding: 2rem;">${t.noComments}</p>`;
            updateCommentCount(0);
            return;
        }

        // Build comment tree (parent comments and replies)
        const parentComments = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        let html = '';
        parentComments.forEach(comment => {
            html += renderComment(comment, replies.filter(r => r.parent_id === comment.id));
        });

        commentsList.innerHTML = html;
        updateCommentCount(comments.length);
        
        // Re-initialize Lucide icons
        if (window.lucide) lucide.createIcons();
        
        // Add event listeners for reply buttons
        attachReplyListeners();
    }

    function renderComment(comment, replies = []) {
        const date = new Date(comment.created_at);
        const formattedDate = date.toLocaleDateString(currentLocale === 'ko' ? 'ko-KR' : 'en-US', {
            year: 'numeric', month: 'short', day: 'numeric'
        });

        let repliesHtml = '';
        if (replies.length > 0) {
            repliesHtml = '<div class="replies">';
            replies.forEach(reply => {
                repliesHtml += renderComment(reply, []);
            });
            repliesHtml += '</div>';
        }

        return `
            <div class="comment ${comment.parent_id ? 'reply' : ''}" data-comment-id="${comment.id}">
                <div class="comment-body">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.name)}</span>
                        <span class="comment-date">${formattedDate}</span>
                    </div>
                    <p class="comment-text">${escapeHtml(comment.content)}</p>
                    <div class="comment-actions">
                        <button class="comment-action-btn reply-btn" data-parent-id="${comment.id}">
                            <i data-lucide="reply" width="14" height="14"></i>
                            <span>${t.reply}</span>
                        </button>
                    </div>
                    <div class="inline-reply-form-container hidden" data-reply-form="${comment.id}"></div>
                </div>
                ${repliesHtml}
            </div>
        `;
    }

    function attachReplyListeners() {
        commentsList.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parentId = btn.dataset.parentId;
                const commentEl = btn.closest('.comment');
                const replyFormContainer = commentEl.querySelector(`[data-reply-form="${parentId}"]`);
                
                // Close other reply forms
                document.querySelectorAll('.inline-reply-form-container').forEach(container => {
                    if (container !== replyFormContainer) {
                        container.classList.add('hidden');
                        container.innerHTML = '';
                    }
                });
                
                if (replyFormContainer.classList.contains('hidden')) {
                    replyFormContainer.classList.remove('hidden');
                    replyFormContainer.innerHTML = createReplyFormHTML(parentId);
                    if (window.lucide) lucide.createIcons();
                    replyFormContainer.querySelector('input[name="reply-name"]').focus();
                    
                    const replyForm = replyFormContainer.querySelector('.inline-reply-form');
                    replyForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = replyForm.querySelector('input[name="reply-name"]').value;
                        const text = replyForm.querySelector('textarea[name="reply-text"]').value;
                        await postComment(name, '', text, parentId);
                        replyFormContainer.classList.add('hidden');
                        replyFormContainer.innerHTML = '';
                    });
                    
                    replyFormContainer.querySelector('.cancel-reply-btn').addEventListener('click', () => {
                        replyFormContainer.classList.add('hidden');
                        replyFormContainer.innerHTML = '';
                    });
                } else {
                    replyFormContainer.classList.add('hidden');
                    replyFormContainer.innerHTML = '';
                }
            });
        });
    }

    function createReplyFormHTML(parentId) {
        return `
            <form class="inline-reply-form">
                <div class="reply-form-inputs">
                    <div class="floating-label-group">
                        <input type="text" name="reply-name" placeholder=" " required>
                        <label>${t.yourName}</label>
                    </div>
                    <div class="floating-label-group">
                        <textarea name="reply-text" rows="2" placeholder=" " required></textarea>
                        <label>${t.replyPlaceholder}</label>
                    </div>
                </div>
                <div class="reply-form-actions">
                    <button type="button" class="cancel-reply-btn">${t.cancel}</button>
                    <button type="submit" class="submit-reply-btn">
                        <span>${t.reply}</span>
                        <i data-lucide="send" width="14" height="14"></i>
                    </button>
                </div>
            </form>
        `;
    }

    // Post comment to API
    async function postComment(name, email, content, parentId = null) {
        try {
            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    post: postSlug,
                    name: name,
                    email: email || null,
                    content: content,
                    parent_id: parentId
                })
            });

            if (!response.ok) throw new Error('Failed to post comment');
            
            // Reload comments
            await loadComments();
            return true;
        } catch (error) {
            console.error('Error posting comment:', error);
            alert(t.error);
            return false;
        }
    }

    function updateCommentCount(count) {
        commentCount.textContent = count;
        stickyCount.textContent = count;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Sticky bar scroll behavior
    function handleScroll() {
        const heroSection = document.getElementById('int-hero');
        if (heroSection) {
            const heroBottom = heroSection.offsetTop + heroSection.offsetHeight;
            if (window.scrollY > heroBottom - 100) {
                stickyBar.classList.add('visible');
            } else {
                stickyBar.classList.remove('visible');
            }
        }
    }

    window.addEventListener('scroll', handleScroll);
    handleScroll();

    // Write comment button - scroll to form
    writeCommentBtn.addEventListener('click', () => {
        const formContainer = document.getElementById('new-comment-form-container');
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            document.getElementById('new-commenter-name').focus();
        }, 500);
    });

    // Submit new comment
    newCommentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('new-commenter-name').value;
        const email = document.getElementById('new-commenter-email').value;
        const text = document.getElementById('new-comment-text').value;
        
        // Disable button while posting
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span>${t.posting}</span>`;
        
        const success = await postComment(name, email, text, null);
        
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = `<span>${t.postComment}</span><i data-lucide="send" width="16" height="16"></i>`;
        if (window.lucide) lucide.createIcons();
        
        if (success) {
            newCommentForm.reset();
        }
    });

    // Load comments on page load
    loadComments();
});
</script>
