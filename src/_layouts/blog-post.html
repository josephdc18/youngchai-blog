---
layout: 'base.html'
preloadCSS: '/css/blog.css'
eleventyComputed:
    description: "{{ description | default: blogDescription }}"
    metaTitle: "{{ title | default: blogTitle }}"
    tagTitle: "{{ title | default: blogTitle }}"
    preloadImg: "{{ image }}"
    permalink: "{% if locale == 'ko' %}/ko{% endif %}/blog/{{ slug | default: pageName }}/index.html"
---
{% set currentLocale = locale | default(page.url | getLocale) %}
{% set postTitle = title | default(blogTitle) %}
{% set postDescription = description | default(blogDescription) %}
{% set featuredCollection = 'featured_' + currentLocale %}
{% set postSlug = slug | default(pageName) %}
{% set wordCount = content | striptags | wordcount %}
{% set readTime = (wordCount / 200) | round(0, 'ceil') %}
{% set readTimeMin = 1 if readTime < 1 else readTime %}

{# Tea pairing based on category #}
{% set teaPairings = {
  'ESSAY': { en: 'Jasmine Green', ko: '자스민 그린티' },
  'TRAVEL': { en: 'Earl Grey', ko: '얼그레이' },
  'FOOD': { en: 'Oolong', ko: '우롱차' },
  'STYLE': { en: 'White Peony', ko: '백모단' },
  'LIVING': { en: 'Chamomile', ko: '캐모마일' },
  'TECH': { en: 'Matcha', ko: '말차' },
  'WELLNESS': { en: 'Peppermint', ko: '페퍼민트' },
  'WORK': { en: 'Black Tea', ko: '홍차' },
  'INTERIORS': { en: 'Rooibos', ko: '루이보스' },
  'PHOTOGRAPHY': { en: 'Darjeeling', ko: '다즐링' }
} %}
{% set teaPairing = teaPairings[category | upper] | default({ en: 'Green Tea', ko: '녹차' }) %}

<link rel="stylesheet" href="/css/enhancements.css">

<!-- JSON-LD Article Structured Data -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "{{ postTitle | replace('"', '\\"') }}",
    "description": "{{ postDescription | replace('"', '\\"') }}",
    "image": "https://{{ client.domain }}{{ image }}",
    "author": {
        "@type": "Person",
        "name": "{{ author | default(client.name) }}"
    },
    "publisher": {
        "@type": "Organization",
        "name": "{{ client.name }}",
        "logo": {
            "@type": "ImageObject",
            "url": "https://{{ client.domain }}/assets/logo-light.png"
        }
    },
    "datePublished": "{{ date | date('iso8601') }}",
    "dateModified": "{{ date | date('iso8601') }}",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://{{ client.domain }}{{ page.url }}"
    },
    "articleSection": "{{ category | default('Blog') }}",
    "wordCount": {{ wordCount }},
    "inLanguage": "{{ 'en-US' if currentLocale == 'en' else 'ko-KR' }}"
}
</script>

<!-- Breadcrumb JSON-LD -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "{{ 'nav.home' | t(currentLocale) }}",
            "item": "https://{{ client.domain }}{% if currentLocale == 'ko' %}/ko{% endif %}/"
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "{{ category | default('Blog') }}",
            "item": "https://{{ client.domain }}{% if currentLocale == 'ko' %}/ko{% endif %}/blog/{{ category | lower }}/"
        },
        {
            "@type": "ListItem",
            "position": 3,
            "name": "{{ postTitle }}"
        }
    ]
}
</script>

{% set postsCollection = 'posts_' + currentLocale %}
{% set relatedPosts = collections[postsCollection] | relatedPosts(page, 3) %}
{% set currentSeries = series | getSeriesForPost(postSlug) %}
{% set toc = content | toc %}

<!-- ============================================ -->
<!--                 PARALLAX LANDING             -->
<!-- ============================================ -->

<section id="int-hero" class="parallax-hero">
    <div class="parallax-bg" id="parallax-bg" style="background-image: url('{{ image }}');"></div>
    <div class="parallax-overlay"></div>
    <div class="parallax-content">
        <span class="hero-category">{{ category | upper | default('BLOG') }}</span>
    </div>
</section>

<!-- ============================================ -->
<!--              Main Blog Content               -->
<!-- ============================================ -->

<div class="blog-container main-content-wrapper-3col">
    <!-- Left Sidebar: Table of Contents (Desktop) -->
    {% if toc | length > 2 %}
    <aside class="toc-sidebar desktop-only" id="toc-sidebar">
        <div class="toc-container">
            <h4 class="toc-title">
                <i data-lucide="list" width="16" height="16"></i>
                {{ 'blog.tableOfContents' | t(currentLocale) }}
            </h4>
            <nav>
                <ul class="toc-list">
                    {% for heading in toc %}
                    <li>
                        <a href="#{{ heading.id }}" class="toc-{{ heading.level }}" data-toc-link>{{ heading.text }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
        </div>
    </aside>
    {% endif %}

    <!--Main content -->
    <div class="main-content">
        <!-- ============================================ -->
        <!--                  Blog Article                -->
        <!-- ============================================ -->

        <article class="blog-article">
            <!--Main Article Image-->
            <picture class="blog-mainImage">
                <img src="{{ image }}" alt="{{ imageAlt }}" width="795" height="400" decoding="async"/>
            </picture>

            <!--Article Info-->
            <div class="article-group">
                <h1 class="blog-h1">{{ postTitle }}</h1>
                <div class="blog-authorGroup">
                    <div class="author-info">
                        <!--Author Image-->
                        <picture class="blog-author-img">
                            <img
                                src="/assets/svgs/profile.svg"
                                alt="{{ author }}"
                                width="32"
                                height="32"
                                decoding="async"
                            />
                        </picture>
                        <span class="blog-author">{{ author }}</span>
                        <span aria-hidden="true" class="blog-dot"></span>
                        <!--Blog Date-->
                        <span class="blog-date">{{ date | postDateLocale(currentLocale) }}</span>
                    </div>
                    
                    <!--Share Links-->
                    <div class="share-links">
                        <span class="share-label">{{ 'Share' if currentLocale == 'en' else '공유' }}</span>
                        <a href="https://pinterest.com/pin/create/button/?url=https://{{ client.domain }}{{ page.url }}&media={{ image | urlencode }}&description={{ postTitle | urlencode }}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="share-link share-pinterest"
                           aria-label="Share on Pinterest">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.373 0 0 5.372 0 12c0 5.084 3.163 9.426 7.627 11.174-.105-.949-.2-2.405.042-3.441.218-.937 1.407-5.965 1.407-5.965s-.359-.719-.359-1.782c0-1.668.967-2.914 2.171-2.914 1.023 0 1.518.769 1.518 1.69 0 1.029-.655 2.568-.994 3.995-.283 1.194.599 2.169 1.777 2.169 2.133 0 3.772-2.249 3.772-5.495 0-2.873-2.064-4.882-5.012-4.882-3.414 0-5.418 2.561-5.418 5.207 0 1.031.397 2.138.893 2.738.098.119.112.224.083.345l-.333 1.36c-.053.22-.174.267-.402.161-1.499-.698-2.436-2.889-2.436-4.649 0-3.785 2.75-7.262 7.929-7.262 4.163 0 7.398 2.967 7.398 6.931 0 4.136-2.607 7.464-6.227 7.464-1.216 0-2.359-.631-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24 12 24c6.627 0 12-5.373 12-12 0-6.628-5.373-12-12-12z"/>
                            </svg>
                        </a>
                        <a href="mailto:?subject={{ postTitle | urlencode }}&body={{ 'Check out this article: ' if currentLocale == 'en' else '이 글을 확인해보세요: ' }}https://{{ client.domain }}{{ page.url }}" 
                           class="share-link share-email"
                           aria-label="Share via Email">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="4" width="20" height="16" rx="2"/>
                                <path d="M22 7l-10 6L2 7"/>
                            </svg>
                        </a>
                        <!-- Copy Link -->
                        <button class="share-link share-copy" id="copy-link-btn"
                           aria-label="{{ 'Copy link' if currentLocale == 'en' else '링크 복사' }}">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                            </svg>
                        </button>
                        <!-- Print Button -->
                        <button onclick="window.print()" class="share-link print-btn" aria-label="{{ 'blog.printArticle' | t(currentLocale) }}">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                <rect x="6" y="14" width="12" height="8"></rect>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Read Time + Tea Pairing -->
                <div class="read-info">
                    <div class="read-time">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
                        </svg>
                        <span>{{ readTimeMin }} {{ 'min read' if currentLocale == 'en' else '분 읽기' }}</span>
                    </div>
                    <div class="read-divider"></div>
                    <div class="tea-pairing">
                        <span>☕</span>
                        <span>{{ 'Perfect with:' if currentLocale == 'en' else '추천 차:' }}</span>
                        <span class="tea-name">{{ teaPairing[currentLocale] }}</span>
                    </div>
                </div>

                <!-- Reading Controls -->
                <div class="reading-controls">
                    <button class="reading-btn" id="reading-mode-btn" title="{{ 'Focus Mode' if currentLocale == 'en' else '집중 모드' }}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                        </svg>
                        <span>{{ 'Focus' if currentLocale == 'en' else '집중' }}</span>
                    </button>
                    <button class="tts-btn" id="tts-btn" title="{{ 'Listen to Article' if currentLocale == 'en' else '글 듣기' }}">
                        <svg class="tts-play-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                        </svg>
                        <svg class="tts-pause-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                        </svg>
                        <span>{{ 'Listen' if currentLocale == 'en' else '듣기' }}</span>
                    </button>
                </div>
            </div>

            <!-- Series Navigation (if part of a series) -->
            {% if currentSeries %}
            <div class="series-nav">
                <div class="series-header">
                    <i data-lucide="layers" width="16" height="16"></i>
                    <span class="series-label">{{ 'blog.partOfSeries' | t(currentLocale) }}</span>
                </div>
                <h4 class="series-title">{{ currentSeries.title[currentLocale] | default(currentSeries.title.en) }}</h4>
                <ol class="series-posts">
                    {% set seriesPosts = collections[postsCollection] | getSeriesPosts(currentSeries) %}
                    {% for seriesPost in seriesPosts %}
                    <li class="{% if seriesPost.data.slug == postSlug or seriesPost.fileSlug == postSlug %}current{% endif %}">
                        <a href="{{ seriesPost.url }}">{{ seriesPost.data.title | default(seriesPost.data.blogTitle) }}</a>
                    </li>
                    {% endfor %}
                </ol>
            </div>
            {% endif %}

            <!-- Table of Contents (for long posts) -->
            {% if toc | length > 2 %}
            <div class="toc-inline desktop-hide">
                <details>
                    <summary>
                        <i data-lucide="list" width="16" height="16"></i>
                        {{ 'blog.tableOfContents' | t(currentLocale) }}
                    </summary>
                    <nav class="toc-list-inline">
                        <ul>
                            {% for heading in toc %}
                            <li class="toc-{{ heading.level }}">
                                <a href="#{{ heading.id }}">{{ heading.text }}</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </nav>
                </details>
            </div>
            {% endif %}

            <section id="blog-content">
                {{ content | safe }}
            </section>

            <!-- Related Posts -->
            {% if relatedPosts | length > 0 %}
            <section class="related-posts">
                <h3 class="related-posts-title">
                    <i data-lucide="sparkles" width="20" height="20"></i>
                    {{ 'blog.relatedPosts' | t(currentLocale) }}
                </h3>
                <div class="related-posts-grid">
                    {% for relatedPost in relatedPosts %}
                    <a href="{{ relatedPost.url }}" class="related-post-card">
                        {% if relatedPost.data.image %}
                        <div class="related-post-image">
                            <img src="{{ relatedPost.data.image }}" alt="{{ relatedPost.data.imageAlt | default(relatedPost.data.title) }}" loading="lazy">
                        </div>
                        {% endif %}
                        <span class="related-post-category">{{ relatedPost.data.category | upper | default('BLOG') }}</span>
                        <h4 class="related-post-title">{{ relatedPost.data.title | default(relatedPost.data.blogTitle) }}</h4>
                    </a>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </article>

        <!-- ============================================ -->
        <!--              Comments Section                -->
        <!-- ============================================ -->
        <section class="comments-section" id="comments-section">
            <div class="comments-header">
                <h2 class="comments-title">
                    <i data-lucide="message-circle" width="24" height="24"></i>
                    <span>{{ 'Comments' if currentLocale == 'en' else '댓글' }}</span>
                    <span class="comment-count" id="comment-count">0</span>
                </h2>
            </div>

            <!-- New Comment Form (Accordion) -->
            <div class="new-comment-form-container" id="new-comment-form-container">
                <button type="button" class="comment-form-toggle" id="comment-form-toggle" aria-expanded="false">
                    <span class="comment-form-toggle-left">
                        <i data-lucide="edit-3" width="18" height="18"></i>
                        <span>{{ 'Write a comment' if currentLocale == 'en' else '댓글 작성' }}</span>
                    </span>
                    <i data-lucide="chevron-down" width="18" height="18" class="toggle-icon"></i>
                </button>
                <form class="inline-comment-form collapsed" id="new-comment-form">
                    <div class="comment-form-row">
                        <div class="floating-label-group">
                            <input type="text" name="commenter-name" id="new-commenter-name" placeholder=" " required>
                            <label for="new-commenter-name">{{ 'Your Name' if currentLocale == 'en' else '이름' }}</label>
                        </div>
                        <div class="floating-label-group">
                            <input type="email" name="commenter-email" id="new-commenter-email" placeholder=" ">
                            <label for="new-commenter-email">{{ 'Email (optional)' if currentLocale == 'en' else '이메일 (선택)' }}</label>
                        </div>
                    </div>
                    <!-- Honeypot field - hidden from users, bots will fill it -->
                    <div class="hp-field" aria-hidden="true">
                        <input type="text" name="website" id="hp-website" tabindex="-1" autocomplete="off">
                    </div>
                    <div class="floating-label-group">
                        <textarea name="comment-text" id="new-comment-text" rows="3" placeholder=" " required></textarea>
                        <label for="new-comment-text">{{ 'Share your thoughts...' if currentLocale == 'en' else '생각을 공유하세요...' }}</label>
                    </div>
                    <!-- Cloudflare Turnstile Widget -->
                    <div class="cf-turnstile" data-sitekey="{{ client.turnstileSiteKey | default('0x4AAAAAAABxxxxxxxxxxxxxxx') }}" data-theme="light"></div>
                    <button type="submit" class="comment-submit-btn" id="submit-comment-btn">
                        <span>{{ 'Post Comment' if currentLocale == 'en' else '댓글 달기' }}</span>
                        <i data-lucide="send" width="16" height="16"></i>
                    </button>
                </form>
            </div>

            <!-- Comments List -->
            <div class="comments-list" id="comments-list">
                <!-- Comments will be loaded from API -->
                <div class="comments-loading" id="comments-loading">
                    <span>{{ 'Loading comments...' if currentLocale == 'en' else '댓글 로딩 중...' }}</span>
                </div>
            </div>
        </section>
    </div>
    <!-- End .main-content -->

    <!-- ============================================ -->
    <!--                   Sidebar                    -->
    <!-- ============================================ -->

    <div class="blog-sidebar">
        <div class="sticky-wrapper">
            <div class="widget-box">
                <div class="corner-tr"></div>
                <div class="corner-bl"></div>

                <div class="widget-header">
                    <i data-lucide="coffee" class="text-accent" width="20" height="20"></i>
                    <h3 class="italic" style="font-size: 1.25rem;">{{ 'blog.popularPosts' | t(currentLocale) }}</h3>
                </div>

                <ul class="widget-list">
                    {% set popularCollection = 'popular_' + currentLocale %}
                    {% set popularPosts = collections[popularCollection] | default(collections.popular) | default([]) %}
                    {% if popularPosts | length > 0 %}
                        {%- for post in popularPosts | head(5) -%}
                            {%- set index = loop.index -%}
                            <li class="group">
                                <div class="widget-list-meta">
                                    <span class="widget-num">{{ index | padStart(2, '0') }}</span>
                                    <span class="widget-tag">{{ post.data.category | upper | default('BLOG') }}</span>
                                </div>
                                <a href="{{ post.url }}">
                                    <h4 class="widget-title">{{ post.data.title | default(post.data.blogTitle) }}</h4>
                                </a>
                            </li>
                        {%- endfor -%}
                    {% else %}
                        <li>
                            <p class="post-excerpt" style="font-size: 0.9rem;">
                                {{ 'Popular posts will appear here.' if currentLocale == 'en' else '인기 글이 여기에 표시됩니다.' }}
                            </p>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Tea Cup Reading Progress -->
<div class="tea-progress" id="tea-progress">
    <div class="tea-cup">
        <div class="tea-fill" id="tea-fill"></div>
    </div>
    <div class="tea-steam" id="tea-steam">
        <div class="steam-line"></div>
        <div class="steam-line"></div>
        <div class="steam-line"></div>
    </div>
    <div class="tea-percent" id="tea-percent">0%</div>
</div>

<!-- Exit Reading Mode Button -->
<button class="exit-reading-mode" id="exit-reading-mode">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"/>
    </svg>
    {{ 'Exit Focus Mode' if currentLocale == 'en' else '집중 모드 종료' }}
</button>

<!-- Sticky Comment Bar -->
<div class="sticky-comment-bar" id="sticky-comment-bar">
    <div class="sticky-comment-inner">
        <div class="sticky-comment-info">
            <i data-lucide="message-circle" width="18" height="18"></i>
            <span><strong id="sticky-count">0</strong> {{ 'Comments' if currentLocale == 'en' else '댓글' }}</span>
        </div>
        <button class="write-comment-btn" id="write-comment-btn">
            <i data-lucide="edit-3" width="16" height="16"></i>
            <span>{{ 'Write a Comment' if currentLocale == 'en' else '댓글 작성' }}</span>
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currentLocale = '{{ currentLocale }}';
    const postSlug = '{{ postSlug }}';
    const API_BASE = '/api/comments';
    
    const stickyBar = document.getElementById('sticky-comment-bar');
    const writeCommentBtn = document.getElementById('write-comment-btn');
    const newCommentForm = document.getElementById('new-comment-form');
    const commentsList = document.getElementById('comments-list');
    const commentsLoading = document.getElementById('comments-loading');
    const commentCount = document.getElementById('comment-count');
    const stickyCount = document.getElementById('sticky-count');
    const submitBtn = document.getElementById('submit-comment-btn');

    // Localized strings
    const strings = {
        en: {
            justNow: 'Just now',
            reply: 'Reply',
            cancel: 'Cancel',
            yourName: 'Your Name',
            replyPlaceholder: 'Write your reply...',
            noComments: 'Be the first to comment!',
            posting: 'Posting...',
            postComment: 'Post Comment',
            error: 'Error posting comment. Please try again.'
        },
        ko: {
            justNow: '방금 전',
            reply: '답글',
            cancel: '취소',
            yourName: '이름',
            replyPlaceholder: '답글을 작성하세요...',
            noComments: '첫 번째 댓글을 남겨보세요!',
            posting: '게시 중...',
            postComment: '댓글 달기',
            error: '댓글 게시 중 오류가 발생했습니다. 다시 시도해주세요.'
        }
    };
    const t = strings[currentLocale] || strings.en;

    // Load comments from API
    async function loadComments() {
        try {
            const response = await fetch(`${API_BASE}?post=${encodeURIComponent(postSlug)}`);
            if (!response.ok) throw new Error('Failed to load comments');
            
            const data = await response.json();
            renderComments(data.comments || []);
        } catch (error) {
            console.error('Error loading comments:', error);
            commentsLoading.innerHTML = `<p style="color: var(--color-gray-medium);">${t.noComments}</p>`;
        }
    }

    // Render comments
    function renderComments(comments) {
        commentsLoading.style.display = 'none';
        
        if (comments.length === 0) {
            commentsList.innerHTML = `<p class="no-comments" style="color: var(--color-gray-medium); text-align: center; padding: 2rem;">${t.noComments}</p>`;
            updateCommentCount(0);
            return;
        }

        // Build comment tree (parent comments and replies)
        const parentComments = comments.filter(c => !c.parent_id);
        const replies = comments.filter(c => c.parent_id);

        let html = '';
        parentComments.forEach(comment => {
            html += renderComment(comment, replies.filter(r => r.parent_id === comment.id));
        });

        commentsList.innerHTML = html;
        updateCommentCount(comments.length);
        
        // Re-initialize Lucide icons
        if (window.lucide) lucide.createIcons();
        
        // Add event listeners for reply buttons
        attachReplyListeners();
    }

    function renderComment(comment, replies = []) {
        const date = new Date(comment.created_at);
        const formattedDate = date.toLocaleDateString(currentLocale === 'ko' ? 'ko-KR' : 'en-US', {
            year: 'numeric', month: 'short', day: 'numeric'
        });

        let repliesHtml = '';
        if (replies.length > 0) {
            repliesHtml = '<div class="replies">';
            replies.forEach(reply => {
                repliesHtml += renderComment(reply, []);
            });
            repliesHtml += '</div>';
        }

        return `
            <div class="comment ${comment.parent_id ? 'reply' : ''}" data-comment-id="${comment.id}">
                <div class="comment-body">
                    <div class="comment-header">
                        <span class="comment-author">${escapeHtml(comment.name)}</span>
                        <span class="comment-date">${formattedDate}</span>
                    </div>
                    <p class="comment-text">${escapeHtml(comment.content)}</p>
                    <div class="comment-actions">
                        <button class="comment-action-btn reply-btn" data-parent-id="${comment.id}">
                            <i data-lucide="reply" width="14" height="14"></i>
                            <span>${t.reply}</span>
                        </button>
                    </div>
                    <div class="inline-reply-form-container hidden" data-reply-form="${comment.id}"></div>
                </div>
                ${repliesHtml}
            </div>
        `;
    }

    function attachReplyListeners() {
        commentsList.querySelectorAll('.reply-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const parentId = btn.dataset.parentId;
                const commentEl = btn.closest('.comment');
                const replyFormContainer = commentEl.querySelector(`[data-reply-form="${parentId}"]`);
                
                // Close other reply forms
                document.querySelectorAll('.inline-reply-form-container').forEach(container => {
                    if (container !== replyFormContainer) {
                        container.classList.add('hidden');
                        container.innerHTML = '';
                    }
                });
                
                if (replyFormContainer.classList.contains('hidden')) {
                    replyFormContainer.classList.remove('hidden');
                    replyFormContainer.innerHTML = createReplyFormHTML(parentId);
                    if (window.lucide) lucide.createIcons();
                    replyFormContainer.querySelector('input[name="reply-name"]').focus();
                    
                    const replyForm = replyFormContainer.querySelector('.inline-reply-form');
                    replyForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const name = replyForm.querySelector('input[name="reply-name"]').value;
                        const text = replyForm.querySelector('textarea[name="reply-text"]').value;
                        await postComment(name, '', text, parentId);
                        replyFormContainer.classList.add('hidden');
                        replyFormContainer.innerHTML = '';
                    });
                    
                    replyFormContainer.querySelector('.cancel-reply-btn').addEventListener('click', () => {
                        replyFormContainer.classList.add('hidden');
                        replyFormContainer.innerHTML = '';
                    });
                } else {
                    replyFormContainer.classList.add('hidden');
                    replyFormContainer.innerHTML = '';
                }
            });
        });
    }

    function createReplyFormHTML(parentId) {
        return `
            <form class="inline-reply-form">
                <div class="reply-form-inputs">
                    <div class="floating-label-group">
                        <input type="text" name="reply-name" placeholder=" " required>
                        <label>${t.yourName}</label>
                    </div>
                    <div class="floating-label-group">
                        <textarea name="reply-text" rows="2" placeholder=" " required></textarea>
                        <label>${t.replyPlaceholder}</label>
                    </div>
                </div>
                <div class="reply-form-actions">
                    <button type="button" class="cancel-reply-btn">${t.cancel}</button>
                    <button type="submit" class="submit-reply-btn">
                        <span>${t.reply}</span>
                        <i data-lucide="send" width="14" height="14"></i>
                    </button>
                </div>
            </form>
        `;
    }

    // Post comment to API
    async function postComment(name, email, content, parentId = null, turnstileToken = null) {
        try {
            const response = await fetch(API_BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    post: postSlug,
                    name: name,
                    email: email || null,
                    content: content,
                    parent_id: parentId,
                    turnstile_token: turnstileToken
                })
            });

            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to post comment');
            }
            
            // Reset Turnstile after successful submission
            const turnstileWidget = document.querySelector('.cf-turnstile');
            if (window.turnstile && turnstileWidget) {
                try {
                    turnstile.reset(turnstileWidget);
                } catch (e) {
                    console.log('Turnstile reset skipped:', e.message);
                }
            }
            
            // Reload comments
            await loadComments();
            return true;
        } catch (error) {
            console.error('Error posting comment:', error);
            alert(error.message || t.error);
            return false;
        }
    }

    function updateCommentCount(count) {
        commentCount.textContent = count;
        stickyCount.textContent = count;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Sticky bar scroll behavior
    function handleScroll() {
        const heroSection = document.getElementById('int-hero');
        if (heroSection) {
            const heroBottom = heroSection.offsetTop + heroSection.offsetHeight;
            if (window.scrollY > heroBottom - 100) {
                stickyBar.classList.add('visible');
            } else {
                stickyBar.classList.remove('visible');
            }
        }
    }

    window.addEventListener('scroll', handleScroll);
    handleScroll();

    // Comment form accordion toggle
    const commentFormToggle = document.getElementById('comment-form-toggle');
    
    function toggleCommentForm(open) {
        const isOpen = open !== undefined ? open : newCommentForm.classList.contains('collapsed');
        
        if (isOpen) {
            newCommentForm.classList.remove('collapsed');
            newCommentForm.classList.add('expanded');
            commentFormToggle.classList.add('open');
            commentFormToggle.setAttribute('aria-expanded', 'true');
        } else {
            newCommentForm.classList.add('collapsed');
            newCommentForm.classList.remove('expanded');
            commentFormToggle.classList.remove('open');
            commentFormToggle.setAttribute('aria-expanded', 'false');
        }
    }
    
    commentFormToggle.addEventListener('click', () => {
        toggleCommentForm();
        if (window.lucide) lucide.createIcons();
    });

    // Write comment button - scroll to form and expand
    writeCommentBtn.addEventListener('click', () => {
        const formContainer = document.getElementById('new-comment-form-container');
        toggleCommentForm(true); // Expand the form
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => {
            document.getElementById('new-commenter-name').focus();
        }, 500);
        if (window.lucide) lucide.createIcons();
    });

    // Submit new comment
    newCommentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Check honeypot field (bots will fill this)
        const honeypot = document.getElementById('hp-website');
        if (honeypot && honeypot.value) {
            console.log('Honeypot triggered');
            // Silently fail for bots
            newCommentForm.reset();
            return;
        }
        
        const name = document.getElementById('new-commenter-name').value;
        const email = document.getElementById('new-commenter-email').value;
        const text = document.getElementById('new-comment-text').value;
        
        // Get Turnstile token
        const turnstileResponse = document.querySelector('[name="cf-turnstile-response"]');
        const turnstileToken = turnstileResponse ? turnstileResponse.value : null;
        
        // Disable button while posting
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span>${t.posting}</span>`;
        
        const success = await postComment(name, email, text, null, turnstileToken);
        
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.innerHTML = `<span>${t.postComment}</span><i data-lucide="send" width="16" height="16"></i>`;
        if (window.lucide) lucide.createIcons();
        
        if (success) {
            newCommentForm.reset();
        }
    });

    // Load comments on page load
    loadComments();

    // ============================================
    // ENHANCEMENTS
    // ============================================

    // 1. Tea Cup Reading Progress
    const teaProgress = document.getElementById('tea-progress');
    const teaFill = document.getElementById('tea-fill');
    const teaSteam = document.getElementById('tea-steam');
    const teaPercent = document.getElementById('tea-percent');
    const blogContent = document.getElementById('blog-content');

    function updateReadingProgress() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight - windowHeight;
        const scrollTop = window.scrollY;
        const progress = Math.min(Math.max((scrollTop / documentHeight) * 100, 0), 100);

        // Show tea cup after scrolling past hero
        const heroSection = document.getElementById('int-hero');
        if (heroSection && scrollTop > heroSection.offsetHeight) {
            teaProgress.classList.add('visible');
        } else {
            teaProgress.classList.remove('visible');
        }

        // Update fill level
        teaFill.style.height = progress + '%';
        teaPercent.textContent = Math.round(progress) + '%';

        // Show steam when near completion
        if (progress > 85) {
            teaSteam.classList.add('active');
        } else {
            teaSteam.classList.remove('active');
        }

        // Save progress for continue reading
        if (progress > 5 && progress < 95) {
            localStorage.setItem('reading_progress_' + postSlug, JSON.stringify({
                progress: progress,
                scrollTop: scrollTop,
                timestamp: Date.now()
            }));
        }
    }

    window.addEventListener('scroll', updateReadingProgress);
    updateReadingProgress();

    // 2. Time of Day Theme
    function setTimeOfDayTheme() {
        const hour = new Date().getHours();
        const body = document.body;
        
        // Remove existing TOD classes
        body.classList.remove('tod-morning', 'tod-afternoon', 'tod-evening', 'tod-night');
        
        if (hour >= 6 && hour < 12) {
            body.classList.add('tod-morning');
        } else if (hour >= 12 && hour < 18) {
            body.classList.add('tod-afternoon');
        } else if (hour >= 18 && hour < 22) {
            body.classList.add('tod-evening');
        } else {
            body.classList.add('tod-night');
        }
    }
    setTimeOfDayTheme();

    // 6. Reading Mode Toggle
    const readingModeBtn = document.getElementById('reading-mode-btn');
    const exitReadingMode = document.getElementById('exit-reading-mode');

    readingModeBtn.addEventListener('click', () => {
        document.body.classList.toggle('reading-mode');
        readingModeBtn.classList.toggle('active');
    });

    exitReadingMode.addEventListener('click', () => {
        document.body.classList.remove('reading-mode');
        readingModeBtn.classList.remove('active');
    });

    // 7. Text-to-Speech
    const ttsBtn = document.getElementById('tts-btn');
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let isSpeaking = false;

    ttsBtn.addEventListener('click', () => {
        if (!speechSynthesis) {
            alert('{{ "Text-to-speech not supported in this browser" if currentLocale == "en" else "이 브라우저에서는 음성 지원이 되지 않습니다" }}');
            return;
        }

        if (isSpeaking) {
            speechSynthesis.cancel();
            isSpeaking = false;
            ttsBtn.classList.remove('playing');
        } else {
            const content = blogContent.innerText;
            currentUtterance = new SpeechSynthesisUtterance(content);
            currentUtterance.lang = currentLocale === 'ko' ? 'ko-KR' : 'en-US';
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;

            currentUtterance.onend = () => {
                isSpeaking = false;
                ttsBtn.classList.remove('playing');
            };

            currentUtterance.onerror = () => {
                isSpeaking = false;
                ttsBtn.classList.remove('playing');
            };

            speechSynthesis.speak(currentUtterance);
            isSpeaking = true;
            ttsBtn.classList.add('playing');
        }
    });

    // Stop TTS when leaving page
    window.addEventListener('beforeunload', () => {
        if (speechSynthesis) speechSynthesis.cancel();
    });

    // ============================================
    // PARALLAX HERO EFFECT
    // ============================================
    const parallaxBg = document.getElementById('parallax-bg');
    if (parallaxBg) {
        window.addEventListener('scroll', () => {
            const scrolled = window.scrollY;
            const rate = scrolled * 0.3;
            parallaxBg.style.transform = `translateY(${rate}px)`;
        }, { passive: true });
    }

    // ============================================
    // TABLE OF CONTENTS HIGHLIGHTING
    // ============================================
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    const articleHeadings = document.querySelectorAll('#blog-content h2, #blog-content h3');
    
    if (tocLinks.length > 0 && articleHeadings.length > 0) {
        function updateTocHighlight() {
            const scrollPosition = window.scrollY + 150;
            
            let currentHeadingId = null;
            articleHeadings.forEach(heading => {
                if (heading.offsetTop <= scrollPosition) {
                    currentHeadingId = heading.id;
                }
            });
            
            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + currentHeadingId) {
                    link.classList.add('active');
                }
            });
        }
        
        window.addEventListener('scroll', updateTocHighlight, { passive: true });
        updateTocHighlight();
    }

    // ============================================
    // HIGHLIGHT & SHARE (Text Selection)
    // ============================================
    const highlightPopup = document.createElement('div');
    highlightPopup.className = 'highlight-share-popup';
    highlightPopup.innerHTML = `
        <button class="highlight-share-btn" id="copy-link-selection" title="{{ 'Copy link' if currentLocale == 'en' else '링크 복사' }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
        </button>
        <button class="highlight-share-btn" id="copy-selection" title="{{ 'Copy text' if currentLocale == 'en' else '텍스트 복사' }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
        </button>
    `;
    document.body.appendChild(highlightPopup);

    function getSelectedText() {
        return window.getSelection().toString().trim();
    }

    function showHighlightPopup(x, y) {
        highlightPopup.style.left = x + 'px';
        highlightPopup.style.top = (y - 50) + 'px';
        highlightPopup.classList.add('visible');
    }

    function hideHighlightPopup() {
        highlightPopup.classList.remove('visible');
    }

    blogContent?.addEventListener('mouseup', (e) => {
        const selectedText = getSelectedText();
        if (selectedText.length > 5) {
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            showHighlightPopup(rect.left + rect.width / 2 + window.scrollX, rect.top + window.scrollY);
        } else {
            hideHighlightPopup();
        }
    });

    document.addEventListener('mousedown', (e) => {
        if (!highlightPopup.contains(e.target)) {
            hideHighlightPopup();
        }
    });

    document.getElementById('copy-link-selection')?.addEventListener('click', async () => {
        const url = window.location.href;
        try {
            await navigator.clipboard.writeText(url);
            // Optional: Show feedback
        } catch (err) {
            console.log('Failed to copy link');
        }
        hideHighlightPopup();
    });

    document.getElementById('copy-selection')?.addEventListener('click', async () => {
        const text = getSelectedText();
        try {
            await navigator.clipboard.writeText(text);
            const btn = document.getElementById('copy-selection');
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
            setTimeout(() => {
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
            }, 2000);
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        hideHighlightPopup();
    });

    // Copy link button in share row
    document.getElementById('copy-link-btn')?.addEventListener('click', async () => {
        const url = window.location.href;
        const btn = document.getElementById('copy-link-btn');
        try {
            await navigator.clipboard.writeText(url);
            // Show check mark temporarily
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 2000);
        } catch (err) {
            console.error('Failed to copy link:', err);
        }
    });

    // Re-initialize Lucide icons for any new elements
    if (window.lucide) lucide.createIcons();
});
</script>
